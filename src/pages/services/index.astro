---
import MainLayout from '../../layouts/MainLayout.astro';
import { getServices, getImageUrl, getSiteSettings } from '../../lib/directus.js';

// Fetch services and settings from Directus
const directusServices = await getServices();
const siteSettings = await getSiteSettings();

const phoneNumber = siteSettings?.phone || '+639XXXXXXXXX';

// Use Directus data if available, otherwise show empty
const services = directusServices || [];
---

<MainLayout 
  title="Services" 
  description="Professional auto care services at WheelPower - tire installation, wheel alignment, vulcanizing, oil change, and more in Baras, Rizal."
>

  <!-- Page Header -->
  <section class="bg-gradient-to-b from-dark-900 to-dark-950 py-16 md:py-24">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="section-subtitle">What We Do</p>
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">Our Services</h1>
      <p class="text-dark-300 text-lg max-w-2xl mx-auto">
        From tire installation to complete vehicle maintenance, we provide professional 
        auto care services to keep you safe on the road.
      </p>
    </div>
  </section>

  <!-- Services List -->
  <section class="py-16 md:py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      {services.length > 0 ? (
        <div class="space-y-16">
          {services.map((service, index) => (
            <div id={service.id || `service-${index}`} class="scroll-mt-24">
              <div class={`grid lg:grid-cols-2 gap-8 lg:gap-12 items-center ${index % 2 === 1 ? 'lg:flex-row-reverse' : ''}`}>
                
                <!-- Service Image/Icon -->
                <div class={`${index % 2 === 1 ? 'lg:order-2' : ''}`}>
                  <div
                    class="aspect-video bg-gradient-to-br from-dark-800 to-dark-900 rounded-2xl border border-dark-700/50 flex items-center justify-center overflow-hidden cursor-pointer service-image-trigger group"
                    data-image={service.image ? getImageUrl(service.image) : ''}
                    data-name={service.name || ''}
                    data-description={service.short_description || ''}
                    data-price={service.price || 'Contact for quote'}
                    data-icon={service.icon || 'ðŸ”§'}
                    data-service-id={service.id || service.name?.toLowerCase().replace(/\s+/g, '-')}
                  >
                    {service.image ? (
                      <img 
                        src={getImageUrl(service.image)} 
                        alt={service.name}
                        class="w-full h-full object-contain p-4 group-hover:scale-105 transition-transform duration-300"
                      />
                    ) : (
                      <div class="text-center group-hover:scale-110 transition-transform duration-300">
                        <div class="text-8xl mb-4">{service.icon || 'ðŸ”§'}</div>
                      </div>
                    )}
                  </div>
                </div>
                
                <!-- Service Info -->
                <div class={`${index % 2 === 1 ? 'lg:order-1' : ''}`}>
                  <div class="inline-flex items-center gap-2 px-3 py-1 bg-primary-500/10 border border-primary-500/30 rounded-full text-primary-400 text-sm font-medium mb-4">
                    <span>{service.icon || 'ðŸ”§'}</span>
                    <span>{service.duration || 'Contact for estimate'}</span>
                  </div>
                  
                  <h2 class="text-2xl md:text-3xl font-bold text-white mb-3">
                    {service.name}
                  </h2>
                  
                  <p class="text-dark-300 mb-4">
                    {service.short_description}
                  </p>
                  
                  {service.description && (
                    <div class="text-dark-400 mb-6 leading-relaxed prose prose-invert prose-sm max-w-none" set:html={service.description} />
                  )}
                  
                  <!-- Price and CTA -->
                  <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                    <div>
                      <p class="text-dark-400 text-sm">Price</p>
                      <p class="text-xl font-bold text-primary-400">{service.price || 'Contact for quote'}</p>
                    </div>
                    <a href={`/book?service=${service.id || service.name?.toLowerCase().replace(/\s+/g, '-')}`} class="btn-primary text-center">
                      Book This Service
                    </a>
                  </div>
                </div>
              </div>
              
              <!-- Divider (except for last item) -->
              {index < services.length - 1 && (
                <div class="border-t border-dark-800 mt-16"></div>
              )}
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-16">
          <div class="text-6xl mb-4">ðŸ”§</div>
          <h3 class="text-xl font-bold text-white mb-2">More services available at our shop!</h3>
          <p class="text-dark-400 mb-6">Contact us to learn about all the services we offer.</p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="/contact" class="btn-secondary">
              Contact Us
            </a>
            <a href={`tel:${phoneNumber.replace(/\s/g, '')}`} class="btn-primary">
              ðŸ“ž Call Us
            </a>
          </div>
        </div>
      )}
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-16 bg-dark-900/50">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-2xl md:text-3xl font-bold text-white mb-4">
        Not Sure What You Need?
      </h2>
      <p class="text-dark-300 mb-8">
        Visit our shop or give us a call. We'll inspect your vehicle and recommend 
        the right services for your needs.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="/contact" class="btn-secondary">
          Contact Us
        </a>
        <a href={`tel:${phoneNumber.replace(/\s/g, '')}`} class="btn-primary">
          ðŸ“ž Call Now
        </a>
      </div>
    </div>
  </section>

</MainLayout>

<!-- Image Modal -->
<div id="image-modal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
  <button id="modal-close" class="absolute top-4 right-4 text-white text-4xl hover:text-primary-400 transition-colors">&times;</button>
  <div class="max-w-3xl w-full">
    <div id="modal-image-container" class="bg-gradient-to-br from-dark-800 to-dark-900 rounded-2xl flex items-center justify-center mb-4 overflow-hidden">
      <img id="modal-image" src="" alt="" class="w-full max-h-[60vh] object-contain" />
      <div id="modal-icon" class="text-9xl hidden"></div>
    </div>
    <div id="modal-details" class="bg-dark-900 rounded-lg p-5 text-center">
      <h3 class="text-2xl font-bold text-white mb-2" id="modal-name"></h3>
      <p class="text-dark-400 mb-4" id="modal-description"></p>
      <p class="text-xl font-bold text-primary-400 mb-4" id="modal-price"></p>
      <a id="modal-action-btn" href="/book" class="inline-block px-6 py-3 bg-primary-500 hover:bg-primary-600 text-white font-medium rounded-lg transition-colors">
        Book This Service
      </a>
    </div>
  </div>
</div>

<!-- Modal Script -->
<script>
  const modal = document.getElementById('image-modal');
  const modalImage = document.getElementById('modal-image');
  const modalIcon = document.getElementById('modal-icon');
  const modalName = document.getElementById('modal-name');
  const modalDescription = document.getElementById('modal-description');
  const modalPrice = document.getElementById('modal-price');
  const modalClose = document.getElementById('modal-close');
  const modalActionBtn = document.getElementById('modal-action-btn');
  const imageTriggers = document.querySelectorAll('.service-image-trigger');

  imageTriggers.forEach((trigger) => {
    trigger.addEventListener('click', () => {
      const image = trigger.dataset.image;
      const icon = trigger.dataset.icon;
      const name = trigger.dataset.name || '';
      const description = trigger.dataset.description || '';
      const price = trigger.dataset.price || 'Contact for quote';
      const serviceId = trigger.dataset.serviceId || '';

      if (image) {
        modalImage.src = image;
        modalImage.alt = name;
        modalImage.classList.remove('hidden');
        modalIcon.classList.add('hidden');
      } else {
        modalImage.classList.add('hidden');
        modalIcon.textContent = icon || 'ðŸ”§';
        modalIcon.classList.remove('hidden');
      }

      modalName.textContent = name;
      modalDescription.textContent = description;
      modalPrice.textContent = price;

      // Build booking URL with service pre-selected and notes
      const notes = `Service: ${name}\nPrice: ${price}`;
      modalActionBtn.href = `/book?service=${serviceId}&notes=${encodeURIComponent(notes)}`;

      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    });
  });

  modalClose.addEventListener('click', () => {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    document.body.style.overflow = '';
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.style.overflow = '';
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.style.overflow = '';
    }
  });
</script>